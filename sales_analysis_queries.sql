/*
Этот скрипт содержит аналитические SQL-запросы к базе данных e-commerce
для анализа поведения клиентов.
Используется синтаксис PostgreSQL.
*/

-- ====================================================================
-- ЗАПРОС 1: Ранжирование продаж для каждого клиента
-- Цель: Пронумеровать все продажи для каждого клиента,
-- чтобы легко найти 1-ю, 2-ю, 3-ю и т.д. транзакцию.
-- ====================================================================

SELECT
    CustomerID,
    OrderID,
    OrderDate,
    
    -- Нумеруем продажи (1, 2, 3...) для каждого клиента
    -- Сортируем по дате, чтобы "Продажа №1" была самой ранней
    ROW_NUMBER() OVER (
        PARTITION BY CustomerID
        ORDER BY OrderDate ASC
    ) AS sale_rank_number

FROM
    fact_Sales_dirty
ORDER BY
    CustomerID,
    sale_rank_number;


-- ====================================================================
-- ЗАПРОС 2: Расчет времени между покупками (Time Between Purchases)
-- Цель: Для каждой продажи найти дату ПРЕДЫДУЩЕЙ продажи
-- этого же клиента. Это первый шаг к расчету "Purchase Frequency".
-- ====================================================================

SELECT
    CustomerID,
    OrderID,
    OrderDate,
    
    -- "Заглядываем" в предыдущую строку (в рамках "окна" клиента)
    -- и берем оттуда дату
    LAG(OrderDate, 1) OVER (
        PARTITION BY CustomerID
        ORDER BY OrderDate ASC
    ) AS previous_order_date

FROM
    fact_Sales_dirty
ORDER BY
    CustomerID,
    OrderDate;